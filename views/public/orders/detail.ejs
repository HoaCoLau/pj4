<%- include('../../partials/header', { pageTitle: pageTitle, isAdminPage: false }); %>
<%- include('../../partials/navbar'); %>

<main role="main" class="container-fluid flex-grow-1 py-3">
<div class="container mt-4">
    <nav aria-label="breadcrumb" style="--bs-breadcrumb-divider: '>';">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Trang chủ</a></li>
        <li class="breadcrumb-item"><a href="/orders">Đơn hàng của tôi</a></li>
        <li class="breadcrumb-item active" aria-current="page">Chi tiết Đơn hàng #<%= order.id %></li>
      </ol>
    </nav>

    <h1 class="mb-4">Chi Tiết Đơn Hàng #<%= order.id %></h1>

    <% if (typeof order !== 'undefined' && order) { %>
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Thông Tin Đơn Hàng</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Mã Đơn Hàng:</strong> #<%= order.id %></p>
                            <p><strong>Ngày Đặt:</strong> <%= new Date(order.orderDate).toLocaleString('vi-VN') %></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Trạng Thái:</strong>
                                <span class="badge rounded-pill
                                    <% if (order.status === 'delivered') { %> bg-success
                                    <% } else if (order.status === 'cancelled' || order.status === 'refunded') { %> bg-danger
                                    <% } else if (order.status === 'shipped') { %> bg-info text-dark
                                    <% } else if (order.status === 'processing') { %> bg-primary
                                    <% } else { %> bg-secondary <% } %>">
                                    <%= order.status.charAt(0).toUpperCase() + order.status.slice(1) %>
                                </span>
                            </p>
                            <p><strong>Phương Thức Thanh Toán:</strong> <%= order.paymentMethod || 'Chưa xác định' %></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Các Sản Phẩm Đã Đặt</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-borderless mb-0">
                            <thead class="table-light small text-muted">
                                <tr>
                                    <th>Sản Phẩm</th>
                                    <th class="text-center">Số lượng</th>
                                    <th class="text-end">Đơn giá</th>
                                    <th class="text-end">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% order.details.forEach(item => { %>
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <% if(item.product && item.product.imageUrl) { %>
                                                <img src="<%= item.product.imageUrl %>" alt="<%= item.productName %>" class="product-img-thumb me-3 rounded">
                                            <% } else { %>
                                                <span data-feather="image" class="product-img-thumb me-3 text-muted d-flex align-items-center justify-content-center border bg-light"></span>
                                            <% } %>
                                            <div>
                                                <h6 class="mb-0 small"><%= item.productName %></h6>
                                                <% if(item.product) { %><small class="text-muted d-block">ID: <%= item.product.id %></small><% } else { %><small class="text-danger d-block">(Sản phẩm không còn tồn tại)</small><% } %>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center"><%= item.quantity %></td>
                                    <td class="text-end"><%= new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(item.priceAtOrder) %></td>
                                    <td class="text-end fw-semibold"><%= new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(item.quantity * item.priceAtOrder) %></td>
                                </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
                 <div class="card-footer text-end bg-light">
                    <h5 class="mb-0">Tổng Cộng: <span class="text-primary fw-bold"><%= new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(order.totalAmount) %></span></h5>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Địa Chỉ Giao Hàng</h5>
                </div>
                <div class="card-body">
                    <address class="mb-0" style="white-space: pre-wrap;"><%= order.shippingAddress ? order.shippingAddress : 'Chưa cung cấp' %></address>
                </div>
            </div>

            <% if (order.billingAddress && order.billingAddress !== order.shippingAddress) { %>
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Địa Chỉ Thanh Toán</h5>
                </div>
                <div class="card-body">
                     <address class="mb-0" style="white-space: pre-wrap;"><%= order.billingAddress %></address>
                </div>
            </div>
            <% } %>

            <% if (order.notes) { %>
                 <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Ghi Chú Đơn Hàng</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-0"><%= order.notes %></p>
                    </div>
                </div>
            <% } %>
        </div>
    </div>
    <% } else { %>
        <div class="alert alert-warning text-center" role="alert">
            Không tìm thấy chi tiết đơn hàng hoặc bạn không có quyền xem đơn hàng này.
        </div>
    <% } %>
     <div class="mt-4">
        <a href="/orders" class="btn btn-outline-secondary">
            <span data-feather="arrow-left" class="align-text-bottom me-1"></span> Quay lại Danh sách Đơn hàng
        </a>
    </div>
</div>
</main>
<%- include('../../partials/footer'); %>