<%- include('../../partials/header', { pageTitle: pageTitle, isAdminPage: true }); %>
<%- include('../../partials/navbar'); %>
<%- include('../../partials/admin-sidebar'); %>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><%= editing ? 'Edit Product' : 'Add New Product' %></h1>
     <div class="btn-toolbar mb-2 mb-md-0">
         <a href="/admin/products" class="btn btn-sm btn-outline-secondary">
             <span data-feather="arrow-left" class="align-text-bottom me-1"></span> Back to List
         </a>
     </div>
</div>

<% if (typeof errors !== 'undefined' && errors && Object.keys(errors).length > 0) { %>
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <strong>Please fix the following errors:</strong>
    <ul>
        <% Object.entries(errors).forEach(([key, errorMessage]) => { %>
            <li><%= errorMessage %></li>
        <% }) %>
    </ul>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
<% } %>

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary"><%= editing ? 'Update Product Details' : 'Enter Product Details' %></h6>
    </div>
    <div class="card-body">
        <form method="POST" action="<%= editing ? '/admin/products/edit/' + product.id : '/admin/products/add' %>" enctype="multipart/form-data" novalidate>
            <div class="row">
                <div class="col-md-8">
                    <div class="mb-3">
                        <label for="name" class="form-label">Product Name <span class="text-danger">*</span></label>
                        <input type="text"
                               class="form-control <%= (errors && errors.name) ? 'is-invalid' : '' %>"
                               id="name" name="name"
                               value="<%= typeof product !== 'undefined' ? product.name : (typeof formData !== 'undefined' ? formData.name : '') %>" required>
                        <% if (errors && errors.name) { %><div class="invalid-feedback"><%= errors.name %></div><% } %>
                    </div>

                     <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control <%= (errors && errors.description) ? 'is-invalid' : '' %>"
                                  id="description" name="description" rows="5"><%= typeof product !== 'undefined' ? product.description : (typeof formData !== 'undefined' ? formData.description : '') %></textarea>
                         <% if (errors && errors.description) { %><div class="invalid-feedback"><%= errors.description %></div><% } %>
                    </div>

                     <div class="row">
                         <div class="col-md-6 mb-3">
                            <label for="price" class="form-label">Price <span class="text-danger">*</span></label>
                             <div class="input-group">
                                 <span class="input-group-text">VNƒê</span>
                                <input type="number" step="1000" min="0"
                                       class="form-control <%= (errors && errors.price) ? 'is-invalid' : '' %>"
                                       id="price" name="price"
                                       value="<%= typeof product !== 'undefined' ? product.price : (typeof formData !== 'undefined' ? formData.price : '') %>" required>
                             </div>
                              <% if (errors && errors.price) { %><div class="invalid-feedback d-block"><%= errors.price %></div><% } %>
                        </div>
                         <div class="col-md-6 mb-3">
                            <label for="stockQuantity" class="form-label">Stock Quantity</label>
                            <input type="number" min="0" step="1"
                                   class="form-control <%= (errors && errors.stockQuantity) ? 'is-invalid' : '' %>"
                                   id="stockQuantity" name="stockQuantity"
                                   value="<%= (typeof product !== 'undefined' && product.stockQuantity !== null) ? product.stockQuantity : (typeof formData !== 'undefined' && formData.stockQuantity !== null ? formData.stockQuantity : '0') %>">
                             <% if (errors && errors.stockQuantity) { %><div class="invalid-feedback"><%= errors.stockQuantity %></div><% } %>
                        </div>
                     </div>
                </div>
                <div class="col-md-4">
                     <div class="mb-3">
                        <label for="categoryId" class="form-label">Category <span class="text-danger">*</span></label>
                        <select class="form-select <%= (errors && errors.categoryId) ? 'is-invalid' : '' %>"
                                id="categoryId" name="categoryId" required>
                            <option value="">-- Select Category --</option>
                            <% if (typeof categories !== 'undefined' && categories.length > 0) { %>
                                <% categories.forEach(category => { %>
                                    <option value="<%= category.id %>"
                                        <% if ((typeof product !== 'undefined' && product.categoryId == category.id) || (typeof formData !== 'undefined' && formData.categoryId == category.id)) { %> selected <% } %> >
                                        <%= category.name %>
                                    </option>
                                <% }) %>
                            <% } %>
                        </select>
                         <% if (errors && errors.categoryId) { %><div class="invalid-feedback"><%= errors.categoryId %></div><% } %>
                    </div>

                     <div class="mb-3">
                        <label for="image" class="form-label">Product Image</label>
                         <% if (editing && product && product.imageUrl) { %>
                             <div class="mb-2 text-center">
                                 <img src="<%= product.imageUrl %>" alt="Current Image" style="max-width: 150px; max-height: 150px; object-fit: contain; border:1px solid #ddd; padding:5px;">
                                 <p class="small text-muted mt-1">Current Image. Upload new to replace.</p>
                             </div>
                         <% } %>
                        <input class="form-control <%= (errors && errors.file_error) ? 'is-invalid' : '' %>"
                               type="file" id="image" name="image" accept="image/png, image/jpeg, image/gif, image/webp">
                         <% if (errors && errors.file_error) { %><div class="invalid-feedback"><%= errors.file_error %></div><% } %>
                         <% else if (errors && errors.image) { %><div class="invalid-feedback"><%= errors.image %></div><% } %> <div class="form-text">Allowed: JPG, PNG, GIF, WEBP. Max 5MB. <%= editing ? '' : '(Required for new product)' %></div>
                    </div>
                </div>
            </div>
            <hr>
            <button type="submit" class="btn btn-primary">
                <span data-feather="<%= editing ? 'save' : 'plus-circle' %>" class="align-text-bottom me-1"></span>
                <%= editing ? 'Update Product' : 'Add Product' %>
            </button>
            <a href="/admin/products" class="btn btn-secondary">Cancel</a>
        </form>
    </div>
</div>

</main>
<%- include('../../partials/footer'); %>