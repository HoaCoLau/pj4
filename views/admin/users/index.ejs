<%- include('../../partials/header', { pageTitle: pageTitle, isAdminPage: true }); %>
<%- include('../../partials/navbar'); %>
<%- include('../../partials/admin-sidebar'); %>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Manage Users</h1>
    </div>

<% if (locals.success_msg || (typeof success !== 'undefined' && success === 'true')) { %><div class="alert alert-success alert-dismissible fade show alert-auto-dismiss" role="alert">Operation successful!<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div><% } %>
<% if (locals.error_msg || (typeof error !== 'undefined' && error)) { %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        An error occurred:
        <% if (error === 'selfdelete') { %> Admin cannot delete their own account. <% } %>
        <% else if (error === 'constraint') { %> Cannot delete user due to existing associations (e.g., orders). <% } %>
        <% else if (error === 'notfound') { %> User not found. <% } %>
        <% else { %> Please try again. <% } %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
<% } %>

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">All Users</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="dataTableUsers" width="100%" cellspacing="0">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Image</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (typeof users !== 'undefined' && users.length > 0) { %>
                        <% users.forEach(user => { %>
                            <tr>
                                <td><%= user.id %></td>
                                <td><%= user.name %></td>
                                <td><%= user.email %></td>
                                <td>
                                    <span class="badge rounded-pill bg-<%= user.role === 'admin' ? 'danger' : 'info' %>">
                                        <%= user.role.charAt(0).toUpperCase() + user.role.slice(1) %>
                                    </span>
                                </td>
                                <td>
                                    <% if (user.image && user.image.startsWith('/uploads')) { %>
                                        <img src="<%= user.image %>" alt="<%= user.name %>" class="product-img-thumb rounded-circle">
                                    <% } else if (user.image) { %>
                                        <span class="text-muted small">External Image</span>
                                    <% } else { %>
                                        <span data-feather="user" class="text-muted"></span>
                                    <% } %>
                                </td>
                                <td class="text-center">
                                    <a href="/admin/users/edit/<%= user.id %>" class="btn btn-sm btn-warning me-1" title="Edit User">
                                        <span data-feather="edit"></span>
                                    </a>
                                    <% if (currentUser.id !== user.id) { // Admin không thể tự xóa mình %>
                                    <form action="/admin/users/delete/<%= user.id %>" method="POST" style="display: inline;" onsubmit="return confirmDelete(event);">
                                        <button type="submit" class="btn btn-sm btn-danger" title="Delete User">
                                            <span data-feather="user-x"></span>
                                        </button>
                                    </form>
                                    <% } else { %>
                                         <button type="button" class="btn btn-sm btn-danger" disabled title="Cannot delete self">
                                            <span data-feather="user-x"></span>
                                        </button>
                                    <% } %>
                                </td>
                            </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="6" class="text-center">No users found.</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
</div>

</main>
<%- include('../../partials/footer'); %>