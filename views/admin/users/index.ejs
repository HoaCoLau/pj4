<% layout('layouts/admin') -%>

<h1><%= title %></h1>

<div class="card mb-4">
    <div class="card-header">
        Thông tin chung
    </div>
    <div class="card-body">
        <p><strong>ID Đơn hàng:</strong> <%= order.id %></p>
        <p><strong>Người đặt:</strong> <%= order.user ? order.user.name + ' (' + order.user.email + ')' : 'Khách (ID: ' + order.user_id + ')' %></p>
        <p><strong>Ngày đặt:</strong> <%= order.order_date.toLocaleString() %></p>
        <p><strong>Tổng tiền:</strong> <%= order.total_amount.toFixed(2) %></p>
        <p><strong>Trạng thái:</strong>
             <span class="badge <%=
                order.status === 'pending' ? 'bg-warning text-dark' :
                order.status === 'processing' ? 'bg-info' :
                order.status === 'shipped' ? 'bg-primary' :
                order.status === 'delivered' ? 'bg-success' :
                order.status === 'cancelled' ? 'bg-danger' :
                order.status === 'refunded' ? 'bg-secondary' : ''
            %>">
                <%= order.status %>
            </span>
        </p>
        <p><strong>Địa chỉ giao hàng:</strong> <%= order.shipping_address %></p>
        <p><strong>Địa chỉ thanh toán:</strong> <%= order.billing_address %></p>
        <p><strong>Phương thức thanh toán:</strong> <%= order.payment_method %></p>
        <p><strong>Ghi chú:</strong> <%= order.notes || 'Không có' %></p>

        <h5 class="mt-4">Cập nhật trạng thái:</h5>
        <form action="/admin/orders/update-status/<%= order.id %>?_method=PUT" method="POST" class="row g-3 align-items-center">
            <input type="hidden" name="_method" value="PUT">
            <div class="col-auto">
                <label for="status" class="visually-hidden">Trạng thái</label>
                 <select class="form-select" id="status" name="status">
                    <option value="pending" <%= order.status === 'pending' ? 'selected' : '' %>>pending</option>
                    <option value="processing" <%= order.status === 'processing' ? 'selected' : '' %>>processing</option>
                    <option value="shipped" <%= order.status === 'shipped' ? 'selected' : '' %>>shipped</option>
                    <option value="delivered" <%= order.status === 'delivered' ? 'selected' : '' %>>delivered</option>
                    <option value="cancelled" <%= order.status === 'cancelled' ? 'selected' : '' %>>cancelled</option>
                    <option value="refunded" <%= order.status === 'refunded' ? 'selected' : '' %>>refunded</option>
                 </select>
            </div>
             <div class="col-auto">
                <button type="submit" class="btn btn-primary"><i class="fas fa-sync-alt"></i> Cập nhật</button>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header">
        Chi tiết Đơn hàng
    </div>
    <div class="card-body">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Sản phẩm</th>
                    <th>Số lượng</th>
                    <th>Giá tại thời điểm đặt</th>
                    <th>Tổng</th>
                </tr>
            </thead>
            <tbody>
                <% order.orderDetails.forEach(detail => { %>
                    <tr>
                        <td>
                            <% if (detail.product) { %>
                                <img src="<%= detail.product.image_url || '/images/placeholder.png' %>" alt="<%= detail.product.name %>" style="width: 50px; height: auto; margin-right: 10px;">
                                <%= detail.product.name %>
                            <% } else { %>
                                <%= detail.product_name %> {# Hiển thị tên nếu sản phẩm gốc bị xóa #}
                            <% } %>
                        </td>
                        <td><%= detail.quantity %></td>
                        <td><%= detail.price_at_order.toFixed(2) %></td>
                        <td><%= (detail.quantity * detail.price_at_order).toFixed(2) %></td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    </div>
</div>

<p class="mt-3"><a href="/admin/orders" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Trở về danh sách</a></p>
