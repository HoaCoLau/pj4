<%- include('../partials/header', { title: title }) %>

<div class="container product-listing-page">
    <h1><%= title %></h1>

    <div class="filters">
        <form method="GET" action="/products">
            <select name="category" onchange="this.form.submit()">
                <option value="">Tất cả Danh mục</option>
                <% categories.forEach(cat => { %>
                    <option value="<%= cat.id %>" <%= typeof currentCategory !== 'undefined' && currentCategory == cat.id ? 'selected' : '' %>>
                        <%= cat.name %>
                    </option>
                <% }); %>
            </select>

            <input type="text" name="search" placeholder="Tìm kiếm sản phẩm..." value="<%= typeof currentSearch !== 'undefined' ? currentSearch : '' %>">

            <select name="sort" onchange="this.form.submit()">
                <option value="created_at_desc" <%= typeof currentSort !== 'undefined' && currentSort === 'created_at_desc' ? 'selected' : '' %>>Mới nhất</option>
                <option value="price_asc" <%= typeof currentSort !== 'undefined' && currentSort === 'price_asc' ? 'selected' : '' %>>Giá: Tăng dần</option>
                <option value="price_desc" <%= typeof currentSort !== 'undefined' && currentSort === 'price_desc' ? 'selected' : '' %>>Giá: Giảm dần</option>
                <option value="name_asc" <%= typeof currentSort !== 'undefined' && currentSort === 'name_asc' ? 'selected' : '' %>>Tên: A-Z</option>
                <option value="name_desc" <%= typeof currentSort !== 'undefined' && currentSort === 'name_desc' ? 'selected' : '' %>>Tên: Z-A</option>
            </select>
            <button type="submit">Lọc</button>
            <a href="/products">Xóa bộ lọc</a>
        </form>
    </div>

    <% if (products && products.length > 0) { %>
        <div class="product-grid">
            <% products.forEach(product => { %>
                <div class="product-card">
                    <a href="/products/<%= product.id %>">
                        <img src="<%= product.image_url ? product.image_url : '/images/placeholder.png' %>" alt="<%= product.name %>">
                        <h3><%= product.name %></h3>
                        <% if (product.category_name) { %>
                            <p class="category"><%= product.category_name %></p>
                        <% } %>
                        <p class="price"><%= new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(product.price) %></p>
                    </a>
                     <form action="/cart/add/<%= product.id %>" method="POST" class="add-to-cart-form">
                         <input type="number" name="quantity" value="1" min="1" style="width: 50px;">
                         <button type="submit" class="btn-add-to-cart">Thêm vào giỏ</button>
                    </form>
                </div>
            <% }); %>
        </div>

        <% if (totalPages > 1) { %>
            <nav class="pagination">
                <ul>
                    <% for (let i = 1; i <= totalPages; i++) { %>
                        <li class="<%= currentPage === i ? 'active' : '' %>">
                            <%
                            const params = new URLSearchParams({
                                category: currentCategory || '',
                                search: currentSearch || '',
                                sort: currentSort || '',
                                page: i
                            });
                            %>
                            <a href="/products?<%= params.toString() %>"><%= i %></a>
                        </li>
                    <% } %>
                </ul>
            </nav>
        <% } %>

    <% } else { %>
        <p>Không tìm thấy sản phẩm nào phù hợp.</p>
    <% } %>
</div>

<%- include('../partials/footer') %>