<%# layout('user/layouts/main') %>

<% if (cart && cartItems && cartItems.length > 0) { %>
    <table class="table">
        <thead>
            <tr>
                <th>Sản phẩm</th>
                <th>Hình ảnh</th>
                <th>Giá</th>
                <th>Số lượng</th>
                <th>Tổng phụ</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody>
            <% cartItems.forEach(item => { %>
                <tr>
                    <td>
                        <% if (item.Product) { %>
                            <a href="/products/<%= item.Product.id %>"><%= item.Product.name %></a>
                            <% if (item.isUnavailable) { %>
                                <br><small class="text-danger">(Không đủ hàng hoặc đã hết)</small>
                            <% } %>
                        <% } else { %>
                            [Sản phẩm đã bị xóa]
                        <% } %>
                    </td>
                    <td>
                        <% if (item.Product) { %>
                        <img src="<%= item.Product.image_url || '/images/placeholder.png' %>" alt="<%= item.Product.name %>" style="width: 50px; height: auto;">
                        <% } %>
                    </td>
                    <td><%= item.Product ? new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(item.Product.price) : 'N/A' %></td>
                    <td>
                        <form action="/cart/update/<%= item.id %>" method="POST" class="d-flex align-items-center">
                            <input type="number" name="quantity" value="<%= item.quantity %>" min="0" class="form-control form-control-sm" style="width: 70px;" <%= !item.Product || item.isUnavailable ? 'disabled' : '' %>>
                            <button type="submit" class="btn btn-sm btn-outline-primary ms-2" <%= !item.Product || item.isUnavailable ? 'disabled' : '' %>>Cập nhật</button>
                        </form>
                    </td>
                    <td><%= item.Product ? new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(item.subtotal) : 'N/A' %></td>
                    <td>
                        <form action="/cart/remove/<%= item.id %>" method="POST">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Xóa sản phẩm này khỏi giỏ hàng?')">Xóa</button>
                        </form>
                    </td>
                </tr>
            <% }); %>
        </tbody>
    </table>
    <div class="text-end">
        <h4>Tổng cộng: <span class="fw-bold"><%= new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(cartTotal) %></span></h4>
        <% if (hasUnavailableProduct) { %>
            <p class="text-danger">Một số sản phẩm trong giỏ hàng không đủ số lượng hoặc đã hết. Vui lòng cập nhật giỏ hàng trước khi thanh toán.</p>
            <a href="/cart" class="btn btn-warning">Cập nhật Giỏ hàng</a>
        <% } else { %>
             <a href="/checkout" class="btn btn-primary btn-lg">Tiến hành Thanh toán</a>
        <% } %>

    </div>
<% } else { %>
    <div class="text-center">
        <p>Giỏ hàng của bạn đang trống.</p>
        <a href="/products" class="btn btn-primary">Tiếp tục mua sắm</a>
    </div>
<% } %>