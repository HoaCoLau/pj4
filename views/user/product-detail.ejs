<%# layout('user/layouts/main') %>

<% if (order) { %>
    <div class="card">
        <div class="card-header">
            <h4>Đơn hàng #<%= order.id %>
                <span class="badge float-end bg-<%= order.status === 'delivered' ? 'success' : (order.status === 'cancelled' || order.status === 'refunded' ? 'danger' : (order.status === 'shipped' ? 'info' : (order.status === 'processing' ? 'primary' : 'warning'))) %>">
                    <%= order.status.charAt(0).toUpperCase() + order.status.slice(1) %>
                </span>
            </h4>
        </div>
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-6">
                    <strong>Ngày đặt hàng:</strong> <%= new Date(order.order_date || order.createdAt).toLocaleString('vi-VN') %><br>
                    <strong>Tổng tiền:</strong> <span class="fw-bold"><%= new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(order.total_amount) %></span><br>
                    <strong>Phương thức thanh toán:</strong> <%= order.payment_method === 'cod' ? 'Thanh toán khi nhận hàng' : 'Chuyển khoản ngân hàng' %>
                </div>
                <div class="col-md-6">
                    <strong>Địa chỉ giao hàng:</strong><br>
                    <%= order.shipping_address %><br>
                    <% if (order.notes) { %>
                        <strong>Ghi chú:</strong> <%= order.notes %>
                    <% } %>
                </div>
            </div>

            <h5>Chi tiết sản phẩm:</h5>
            <table class="table">
                <thead>
                    <tr>
                        <th>Sản phẩm</th>
                        <th>Hình ảnh</th>
                        <th>Đơn giá</th>
                        <th>Số lượng</th>
                        <th>Thành tiền</th>
                    </tr>
                </thead>
                <tbody>
                    <% order.details.forEach(item => { %>
                        <tr>
                            <td>
                                <%= item.product_name %>
                                <% if (item.Product) { %><a href="/products/<%= item.Product.id %>" class="small">(Xem)</a><% } %>
                            </td>
                            <td>
                                <% if (item.Product && item.Product.image_url) { %>
                                    <img src="<%= item.Product.image_url %>" alt="<%= item.product_name %>" style="width: 50px;">
                                <% } else { %>
                                    <img src="/images/placeholder.png" alt="placeholder" style="width: 50px;">
                                <% } %>
                            </td>
                            <td><%= new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(item.price_at_order) %></td>
                            <td><%= item.quantity %></td>
                            <td><%= new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(item.price_at_order * item.quantity) %></td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
        <div class="card-footer">
            <a href="/orders" class="btn btn-secondary">Quay lại Lịch sử đơn hàng</a>
            </div>
    </div>
<% } else { %>
    <p>Không tìm thấy thông tin đơn hàng.</p>
<% } %>