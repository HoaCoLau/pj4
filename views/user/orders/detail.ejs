<% layout('layouts/user') -%>

<h1><%= title %></h1>

<div class="card mb-4">
    <div class="card-header">
        Thông tin chung đơn hàng
    </div>
    <div class="card-body">
        <p><strong>ID Đơn hàng:</strong> <%= order.id %></p>
        <p><strong>Ngày đặt:</strong> <%= order.order_date.toLocaleString() %></p>
         {# Ép kiểu sang số trước khi gọi toFixed #}
        <p><strong>Tổng tiền:</strong> <%= (order && order.total_amount !== null && order.total_amount !== undefined) ? parseFloat(order.total_amount).toFixed(2) : 'N/A' %> VND</p>
        <p><strong>Trạng thái:</strong>
             <span class="badge <%=
                order.status === 'pending' ? 'bg-warning text-dark' :
                order.status === 'processing' ? 'bg-info' :
                order.status === 'shipped' ? 'bg-primary' :
                order.status === 'delivered' ? 'bg-success' :
                order.status === 'cancelled' ? 'bg-danger' :
                order.status === 'refunded' ? 'bg-secondary' : ''
            %>">
                <%= order.status %>
            </span>
        </p>
        <p><strong>Địa chỉ giao hàng:</strong> <%= order.shipping_address %></p>
        <p><strong>Địa chỉ thanh toán:</strong> <%= order.billing_address %></p>
        <p><strong>Phương thức thanh toán:</strong> <%= order.payment_method %></p>
        <p><strong>Ghi chú:</strong> <%= order.notes || 'Không có' %></p>
    </div>
</div>

<div class="card">
    <div class="card-header">
        Chi tiết sản phẩm
    </div>
    <div class="card-body">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Sản phẩm</th>
                    <th>Số lượng</th>
                    <th>Giá tại thời điểm đặt</th>
                    <th>Tổng</th>
                </tr>
            </thead>
            <tbody>
                <% order.orderDetails.forEach(detail => { %>
                    <tr>
                        <td>
                             <% if (detail && detail.product) { %>
                                <img src="<%= detail.product.image_url || '/images/placeholder.png' %>" alt="<%= detail.product.name %>" style="width: 50px; height: auto; margin-right: 10px;">
                                <%= detail.product.name %>
                            <% } else if (detail && detail.product_name) { %>
                                <%= detail.product_name %>
                            <% } else { %>
                                Sản phẩm không xác định
                            <% } %>
                        </td>
                         {# Kiểm tra detail.quantity và detail.price_at_order trước khi tính/gọi toFixed #}
                        <td><%= (detail && detail.quantity !== null && detail.quantity !== undefined) ? detail.quantity : 'N/A' %></td>
                        {# Ép kiểu sang số trước khi gọi toFixed #}
                        <td><%= (detail && detail.price_at_order !== null && detail.price_at_order !== undefined) ? parseFloat(detail.price_at_order).toFixed(2) : 'N/A' %> VND</td>
                        {# Ép kiểu sang số trước khi gọi toFixed #}
                        <td><%= (detail && detail.quantity !== null && detail.quantity !== undefined && detail.price_at_order !== null && detail.price_at_order !== undefined) ? (detail.quantity * parseFloat(detail.price_at_order)).toFixed(2) : 'N/A' %> VND</td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    </div>
</div>

<p class="mt-3"><a href="/user/orders" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Trở về danh sách đơn hàng</a></p>
