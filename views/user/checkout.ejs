<%# layout('user/layouts/main') %>

<div class="row">
    <div class="col-md-7">
        <h2>Thông tin Thanh toán</h2>
        <form action="/checkout" method="POST">
            <input type="hidden" name="redirect" value="<%= locals.redirect || '' %>">

            <div class="mb-3">
                <label for="name" class="form-label">Họ tên người nhận</label>
                <input type="text" class="form-control <%= (locals.errors && errors.name) ? 'is-invalid' : '' %>" id="name" name="name" value="<%= locals.checkoutData && checkoutData.name ? checkoutData.name : (locals.currentUser ? currentUser.name : '') %>" required>
                <% if (locals.errors && errors.name) { %><div class="invalid-feedback"><%= errors.name %></div><% } %>
            </div>

            <div class="mb-3">
                <label for="shipping_address" class="form-label">Địa chỉ giao hàng</label>
                <textarea class="form-control <%= (locals.errors && errors.shipping_address) ? 'is-invalid' : '' %>" id="shipping_address" name="shipping_address" rows="3" required><%= locals.checkoutData && checkoutData.shipping_address ? checkoutData.shipping_address : '' %></textarea>
                <% if (locals.errors && errors.shipping_address) { %><div class="invalid-feedback"><%= errors.shipping_address %></div><% } %>
            </div>

            <div class="mb-3">
                <label for="phone" class="form-label">Số điện thoại</label>
                <input type="tel" class="form-control <%= (locals.errors && errors.phone) ? 'is-invalid' : '' %>" id="phone" name="phone" value="<%= locals.checkoutData && checkoutData.phone ? checkoutData.phone : '' %>" required pattern="[0-9]{10,11}" title="Số điện thoại gồm 10-11 chữ số">
                <% if (locals.errors && errors.phone) { %><div class="invalid-feedback"><%= errors.phone %></div><% } %>
            </div>

            <div class="mb-3">
                <label class="form-label">Phương thức thanh toán</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="payment_method" id="cod" value="cod" <%= (locals.checkoutData && checkoutData.payment_method === 'cod') || !locals.checkoutData ? 'checked' : '' %> required>
                    <label class="form-check-label" for="cod">
                        Thanh toán khi nhận hàng (COD)
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="payment_method" id="bank_transfer" value="bank_transfer" <%= (locals.checkoutData && checkoutData.payment_method === 'bank_transfer') ? 'checked' : '' %> required>
                    <label class="form-check-label" for="bank_transfer">
                        Chuyển khoản ngân hàng
                    </label>
                </div>
                 <% if (locals.errors && errors.payment_method) { %><div class="text-danger small mt-1"><%= errors.payment_method %></div><% } %>
            </div>

            <div class="mb-3">
                <label for="notes" class="form-label">Ghi chú đơn hàng (tùy chọn)</label>
                <textarea class="form-control" id="notes" name="notes" rows="2"><%= locals.checkoutData && checkoutData.notes ? checkoutData.notes : '' %></textarea>
            </div>

             <% if (locals.errors && errors.general) { %>
                <div class="alert alert-danger"><%= errors.general %></div>
            <% } %>
             <% if (hasUnavailableProduct) { %>
                <div class="alert alert-warning">
                    <strong>Lưu ý:</strong> Một số sản phẩm trong giỏ không đủ số lượng hoặc đã hết.
                    Vui lòng <a href="/cart">kiểm tra lại giỏ hàng</a>. Bạn sẽ không thể đặt hàng nếu còn sản phẩm không khả dụng.
                </div>
            <% } %>


            <button type="submit" class="btn btn-primary btn-lg" <%= hasUnavailableProduct ? 'disabled' : '' %>>Đặt hàng</button>
        </form>
    </div>
    <div class="col-md-5">
        <h4>Đơn hàng của bạn</h4>
        <% if (cartItems && cartItems.length > 0) { %>
            <ul class="list-group mb-3">
                <% cartItems.forEach(item => { %>
                    <li class="list-group-item d-flex justify-content-between lh-sm">
                        <div>
                            <h6 class="my-0"><%= item.Product ? item.Product.name : '[Sản phẩm đã xóa]' %></h6>
                            <small class="text-muted">Số lượng: <%= item.quantity %></small>
                             <% if (item.isUnavailable) { %>
                                <br><small class="text-danger">(Không đủ hàng)</small>
                            <% } %>
                        </div>
                        <span class="text-muted"><%= item.Product ? new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(item.subtotal) : 'N/A' %></span>
                    </li>
                <% }); %>
                <li class="list-group-item d-flex justify-content-between">
                    <span>Tổng cộng (VNĐ)</span>
                    <strong><%= new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(cartTotal) %></strong>
                </li>
            </ul>
        <% } else { %>
            <p>Giỏ hàng trống.</p>
        <% } %>
    </div>
</div>